<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼rdÃ¼rÃ¼lebilirlik Raporlama Formu v10</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #d35400;
            --success-color: #27ae60;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
            --child-bg: #fffcf0;
            --child-border: #ffb74d;
            --sidebar-width: 340px;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f6f8; overflow: hidden; }
        
        /* --- MOBÄ°L ÃœST BAR --- */
        .mobile-header {
            display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--primary-color); color: white; align-items: center;
            padding: 0 15px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .menu-toggle {
            background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px;
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-width); background: white; border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease;
            z-index: 1001;
        }
        
        @media (max-width: 992px) {
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .main-content { padding-top: 70px !important; padding-left: 15px !important; padding-right: 15px !important; }
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
            .sidebar-overlay.active { display: block; }
        }

        .framework-selector { display: flex; padding: 10px; gap: 5px; border-bottom: 1px solid #eee; background: #fff; }
        .fw-btn { flex: 1; padding: 10px 5px; border: 1px solid var(--border-color); background: #f8f9fa; color: #666; cursor: pointer; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .fw-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .fw-btn#btn-metrics.active { background: var(--accent-color); border-color: var(--accent-color); }

        .actions-panel { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; background: #fafafa; }
        .action-btn { flex: 1; border: none; padding: 8px; border-radius: 4px; color: white; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
        .btn-save { background-color: var(--success-color); }
        .btn-load { background-color: #8e44ad; }

        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .sidebar-header h2 { margin: 0; font-size: 1rem; color: var(--primary-color); }
        .active-sector-badge { font-size: 0.7rem; color: white; background: var(--secondary-color); padding: 3px 6px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        #sidebar-menu-items { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .nav-group { border-bottom: 1px solid #f0f0f0; }
        .nav-main-item { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; font-weight: 700; color: var(--primary-color); font-size: 0.9rem; }
        .nav-main-item.completed { background-color: #e8f5e9; color: #2e7d32; }
        .nav-sub-item { padding: 8px 15px 8px 30px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #666; font-size: 0.85rem; border-left: 3px solid transparent; }
        .nav-sub-item.active { background: #e3f2fd; color: var(--secondary-color); border-left-color: var(--secondary-color); font-weight: 600; }
        .nav-sub-item.completed { color: var(--success-color); }
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: #eee; color: #777; min-width: 20px; text-align: center; }
        .completed .badge { background: var(--success-color); color: white; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .form-container { max-width: 900px; margin: 0 auto 50px auto; }
        .main-section-header { margin-top: 40px; padding-bottom: 10px; border-bottom: 3px solid var(--primary-color); color: var(--primary-color); font-size: 1.6rem; font-weight: 800; }
        .sub-section-container { margin-top: 25px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .sub-section-header { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        .question-group { margin-bottom: 20px; padding: 20px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
        .question-group.hidden { display: none; }
        .question-group.is-child { background-color: var(--child-bg); border-left: 5px solid var(--child-border); }

        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 1rem; line-height: 1.4; }
        .q-id-badge { font-weight: normal; font-size: 0.75rem; color: #999; background: #f0f0f0; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        .description { font-size: 0.9rem; color: #666; margin-bottom: 12px; background: #fafafa; padding: 8px; border-radius: 4px; line-height: 1.5; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 0.95rem; }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .checkbox-item input { width: 18px; height: 18px; margin-right: 8px; }

        /* --- MODAL --- */
        #sector-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 100%; max-width: 450px; text-align: center; }
        .sector-select { width: 100%; padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
        <div style="font-weight: bold; font-size: 0.9rem;">SÃ¼rdÃ¼rÃ¼lebilirlik Formu</div>
    </div>

    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">

    <div id="sector-modal">
        <div class="modal-content">
            <h2>HoÅŸ Geldiniz</h2>
            <p>Devam etmek iÃ§in firmanÄ±zÄ±n ana sektÃ¶rÃ¼nÃ¼ seÃ§iniz.</p>
            <select id="sectorSelect" class="sector-select"><option value="">YÃ¼kleniyor...</option></select>
            <button id="startBtn" class="start-btn" onclick="startApplication()" disabled style="width:100%; padding:15px; background:var(--secondary-color); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">BAÅžLA</button>
            <button class="modal-load-btn" onclick="document.getElementById('jsonFileInput').click()" style="width:100%; margin-top:10px; background:none; border:1px dashed #ccc; padding:10px; color:#666; cursor:pointer;">ðŸ“‚ Taslak YÃ¼kle</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="framework-selector">
            <button id="btn-tsrs" class="fw-btn active" onclick="switchFramework('tsrs')">TSRS</button>
            <button id="btn-gri" class="fw-btn" onclick="switchFramework('gri')">GRI</button>
            <button id="btn-metrics" class="fw-btn" onclick="switchFramework('metrics')">METRÄ°KLER</button>
        </div>
        <div class="actions-panel">
            <button class="action-btn btn-save" onclick="exportProgress()">ðŸ’¾ Kaydet</button>
            <button class="action-btn btn-load" onclick="document.getElementById('jsonFileInput').click()">ðŸ“‚ YÃ¼kle</button>
        </div>
        <div class="sidebar-header">
            <h2 id="menu-title">TSRS BaÅŸlÄ±klarÄ±</h2>
            <div id="active-sector-display" class="active-sector-badge" style="display:none;"></div>
        </div>
        <div id="sidebar-menu-items"></div>
    </div>

    <div class="main-content" id="mainContent">
        <div style="text-align:center; color:#888; margin-top:50px;">LÃ¼tfen sektÃ¶r seÃ§iniz...</div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzzYVodLj9QirWGkyXaHbpxVjZjDxSXl7anG1mW9HpvYMLlQfIbiHfn4F7WYLAr0Dkn/exec";
        const tsrsOrder = ["Genel HÃ¼kÃ¼mler Ve Bilgiler", "YÃ¶netiÅŸim (Governance)", "Strateji (Strategy)", "Risk YÃ¶netimi (Risk Management)", "Metrikler Ve Hedefler (Metrics & Targets)"];

        let allQuestions = [], filteredQuestions = [], groupedData = {}, questionMap = {}, dependencies = {};
        let currentFramework = 'tsrs', userSector = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch(API_URL).then(res => res.json()).then(data => {
                allQuestions = data;
                const sectors = new Set();
                allQuestions.forEach(q => { if(q.firma_sektor) q.firma_sektor.forEach(s => { if(s && s !== "GENEL") sectors.add(s.trim()); })});
                const sel = document.getElementById('sectorSelect');
                Array.from(sectors).sort().forEach(s => { let o = document.createElement('option'); o.value = o.text = s; sel.add(o); });
                sel.onchange = () => document.getElementById('startBtn').disabled = !sel.value;
            });
        });

        function startApplication() {
            userSector = document.getElementById('sectorSelect').value;
            document.getElementById('sector-modal').style.display = 'none';
            document.getElementById('active-sector-display').textContent = userSector;
            document.getElementById('active-sector-display').style.display = 'inline-block';
            filteredQuestions = allQuestions.filter(q => q.firma_sektor.includes("GENEL") || q.firma_sektor.includes(userSector));
            processData();
        }

        function switchFramework(mode) {
            currentFramework = mode;
            document.querySelectorAll('.fw-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + mode).classList.add('active');
            document.getElementById('menu-title').textContent = mode.toUpperCase() + " BaÅŸlÄ±klarÄ±";
            processData();
            if(window.innerWidth < 992) toggleSidebar();
        }

        function processData() {
            groupedData = {}; questionMap = {}; dependencies = {};
            filteredQuestions.forEach(q => {
                questionMap[q.id] = q;
                if (q.baglilik?.parent_id) {
                    let pid = q.baglilik.parent_id;
                    if(!dependencies[pid]) dependencies[pid] = [];
                    dependencies[pid].push(q.id);
                }
                let m = (currentFramework==='tsrs')?q.konumlandirma?.tsrs?.main:(currentFramework==='gri')?q.konumlandirma?.gri?.main:q.metrik_kategori;
                let s = (currentFramework==='tsrs')?q.konumlandirma?.tsrs?.sub:(currentFramework==='gri')?q.konumlandirma?.gri?.sub:"Genel";
                if(!m) return;
                if(!groupedData[m]) groupedData[m] = {};
                if(!groupedData[m][s]) groupedData[m][s] = [];
                groupedData[m][s].push(q);
            });
            renderUI();
        }

        function renderUI() {
            const mainContent = document.getElementById('mainContent');
            const menu = document.getElementById('sidebar-menu-items');
            mainContent.innerHTML = ''; menu.innerHTML = '';

            let keys = Object.keys(groupedData).sort((a,b) => {
                let iA = tsrsOrder.indexOf(a), iB = tsrsOrder.indexOf(b);
                return (iA===-1?999:iA) - (iB===-1?999:iB);
            });

            keys.forEach((mK, mIdx) => {
                let g = document.createElement('div'); g.className = 'nav-group';
                let mi = document.createElement('div'); mi.className = 'nav-main-item'; mi.id = 'nav-main-'+mIdx;
                mi.innerHTML = `<span>${mK}</span><span class="badge" id="b-m-${mIdx}">0/0</span>`;
                mi.onclick = () => document.getElementById('s-m-'+mIdx).scrollIntoView();
                g.appendChild(mi);

                let sc = document.createElement('div'); sc.className = 'nav-sub-items';
                Object.keys(groupedData[mK]).forEach((sK, sIdx) => {
                    let si = document.createElement('div'); si.className = 'nav-sub-item'; si.id = `nav-sub-${mIdx}-${sIdx}`;
                    si.innerHTML = `<span>${sK}</span><span class="badge" id="b-s-${mIdx}-${sIdx}">0/0</span>`;
                    si.onclick = (e) => { e.stopPropagation(); document.getElementById(`s-s-${mIdx}-${sIdx}`).scrollIntoView(); if(window.innerWidth<992) toggleSidebar(); };
                    sc.appendChild(si);
                });
                g.appendChild(sc); menu.appendChild(g);

                let mh = document.createElement('div'); mh.className = 'main-section-header'; mh.id = 's-m-'+mIdx; mh.textContent = mK;
                mainContent.appendChild(mh);
                Object.keys(groupedData[mK]).forEach((sK, sIdx) => {
                    let sw = document.createElement('div'); sw.className = 'sub-section-container'; sw.id = `s-s-${mIdx}-${sIdx}`;
                    sw.innerHTML = `<div class="sub-section-header">${sK}</div>`;
                    groupedData[mK][sK].forEach(q => sw.appendChild(createQuestionElement(q)));
                    mainContent.appendChild(sw);
                });
            });
            if(window.pRestore) { restoreAnswers(window.pRestore); window.pRestore = null; }
            updateProgress();
        }

        function createQuestionElement(q) {
            let d = document.createElement('div'); d.className = 'question-group'; d.id = 'w-'+q.id;
            if(q.baglilik?.parent_id) d.classList.add('hidden', 'is-child');
            d.innerHTML = `<label>${q.soru_metni}<span class="q-id-badge">${q.id}</span></label>`;
            if(q.soru_aciklama) d.innerHTML += `<div class="description">${q.soru_aciklama}</div>`;
            
            let iH = '', n = 'q_'+q.id;
            if(q.cevap_tipi==='Metin') iH = `<textarea id="${n}"></textarea>`;
            else if(q.cevap_tipi==='Tekli') iH = `<select id="${n}"><option value="">SeÃ§iniz...</option>${q.cevap.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
            else if(q.cevap_tipi==='Ã‡oklu') iH = `<div class="checkbox-group">${q.cevap.map(o=>`<label class="checkbox-item"><input type="checkbox" name="${n}" value="${o}">${o}</label>`).join('')}</div>`;
            else iH = `<input type="${q.cevap_tipi==='SayÄ±'?'number':'text'}" id="${n}" step="${q.cevap_tipi==='Oran'?'0.01':'1'}">`;
            
            let c = document.createElement('div'); c.innerHTML = iH; d.appendChild(c);
            d.querySelectorAll('input, select, textarea').forEach(i => {
                i.onchange = () => { checkTriggers(q.id); updateProgress(); };
            });
            return d;
        }

        function checkTriggers(pid) {
            let val = getAnswerValue(pid);
            (dependencies[pid] || []).forEach(cid => {
                let q = questionMap[cid], el = document.getElementById('w-'+cid);
                if (!el) return;
                let show = val && q.baglilik.tetikleyici.some(t => Array.isArray(val) ? val.includes(t) : val === t);
                el.classList.toggle('hidden', !show);
                if(!show) resetChildren(cid);
            });
        }

        function resetChildren(pid) { (dependencies[pid] || []).forEach(cid => { document.getElementById('w-'+cid)?.classList.add('hidden'); resetChildren(cid); }); }

        function getAnswerValue(id) {
            let q = questionMap[id]; if(!q) return null;
            if(q.cevap_tipi==='Ã‡oklu') return Array.from(document.querySelectorAll(`input[name="q_${id}"]:checked`)).map(c=>c.value);
            return document.getElementById('q_'+id)?.value;
        }

        function updateProgress() {
            Object.keys(groupedData).forEach((mK, mIdx) => {
                let mT = 0, mA = 0;
                Object.keys(groupedData[mK]).forEach((sK, sIdx) => {
                    let qs = groupedData[mK][sK], sT = qs.length, sA = qs.filter(q => { let v = getAnswerValue(q.id); return v && (Array.isArray(v)?v.length>0:v.toString().trim()!==""); }).length;
                    document.getElementById(`b-s-${mIdx}-${sIdx}`).textContent = `${sA}/${sT}`;
                    document.getElementById(`nav-sub-${mIdx}-${sIdx}`).classList.toggle('completed', sA===sT);
                    mT += sT; mA += sA;
                });
                document.getElementById(`b-m-${mIdx}`).textContent = `${mA}/${mT}`;
                document.getElementById(`nav-main-${mIdx}`).classList.toggle('completed', mA===mT);
            });
        }

        function exportProgress() {
            let d = { meta: { sector: userSector, fw: currentFramework }, ans: {} };
            filteredQuestions.forEach(q => { let v = getAnswerValue(q.id); if(v && v.length!==0) d.ans[q.id] = v; });
            let blob = new Blob([JSON.stringify(d)], {type: "application/json"});
            let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Taslak_${userSector}.json`; a.click();
        }

        function handleFileLoad(e) {
            let f = e.target.files[0]; if(!f) return;
            let r = new FileReader(); r.onload = (ev) => {
                let d = JSON.parse(ev.target.result);
                userSector = d.meta.sector; document.getElementById('sectorSelect').value = userSector;
                startApplication(); window.pRestore = d.ans;
                if(d.meta.fw) switchFramework(d.meta.fw);
            }; r.readAsText(f);
        }

        function restoreAnswers(ans) {
            Object.keys(ans).forEach(id => {
                let q = questionMap[id], v = ans[id]; if(!q) return;
                if(q.cevap_tipi==='Ã‡oklu') v.forEach(x => { let c = document.querySelector(`input[name="q_${id}"][value="${x}"]`); if(c) c.checked = true; });
                else { let el = document.getElementById('q_'+id); if(el) el.value = v; }
                checkTriggers(id);
            });
            updateProgress();
        }
    </script>
</body>
</html>

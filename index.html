<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼rdÃ¼rÃ¼lebilirlik Raporlama Formu v9</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #d35400;
            --success-color: #27ae60;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
            --child-bg: #fffcf0;
            --child-border: #ffb74d;
            --sidebar-width: 360px;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f6f8; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        /* MODAL */
        #sector-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); transition: opacity 0.5s ease; }
        .modal-content { background: white; padding: 40px; border-radius: 16px; width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .sector-select { width: 100%; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; outline: none; cursor: pointer; }
        .start-btn { background: var(--secondary-color); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        .start-btn:disabled { background: #ccc; cursor: not-allowed; }
        .modal-load-btn { margin-top: 15px; background: transparent; color: #888; border: 1px dashed #ccc; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .framework-selector { display: flex; padding: 10px; gap: 5px; border-bottom: 1px solid #eee; background: #fff; }
        .fw-btn { flex: 1; padding: 8px; border: 1px solid var(--border-color); background: #f8f9fa; color: #666; cursor: pointer; border-radius: 4px; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
        .fw-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .fw-btn#btn-metrics.active { background: var(--accent-color); border-color: var(--accent-color); }
        
        .actions-panel { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; background: #fafafa; }
        .action-btn { flex: 1; border: none; padding: 8px; border-radius: 4px; color: white; font-size: 0.8rem; cursor: pointer; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-save { background-color: var(--success-color); }
        .btn-load { background-color: #8e44ad; }

        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; background: #fdfdfd; }
        .sidebar-header h2 { margin: 0; font-size: 1rem; color: var(--primary-color); }
        .active-sector-badge { font-size: 0.7rem; color: white; background: var(--secondary-color); padding: 3px 6px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* MENU */
        #sidebar-menu-items { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .nav-group { border-bottom: 1px solid #f0f0f0; }
        .nav-main-item { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; font-weight: 700; color: var(--primary-color); font-size: 0.9rem; transition: background 0.2s; user-select: none; }
        .nav-main-item:hover { background: #f4f6f8; }
        .nav-main-item.active-metric { background: #fff3e0; color: var(--accent-color); border-left: 4px solid var(--accent-color); }
        .nav-sub-items { display: block; background: #fbfbfb; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; transition: max-height 0.3s ease-out; }
        .nav-group.collapsed .nav-sub-items { display: none; }
        .nav-main-item.has-children::after { content: 'â–¼'; font-size: 0.7rem; color: #aaa; transition: transform 0.3s; }
        .nav-group.collapsed .nav-main-item.has-children::after { transform: rotate(-90deg); }
        .nav-sub-item { padding: 10px 15px 10px 30px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #666; font-size: 0.85rem; border-left: 4px solid transparent; transition: all 0.2s; }
        .nav-sub-item:hover { background: #f1f1f1; color: var(--secondary-color); }
        .nav-sub-item.active { background: #e3f2fd; color: var(--secondary-color); border-left-color: var(--secondary-color); font-weight: 600; }
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: #777; min-width: 20px; text-align: center; }
        .completed .badge { background: var(--success-color); color: white; }
        .completed .badge::after { content: ' âœ”'; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 40px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .content-section { display: none; max-width: 900px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .content-section.active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .section-header { font-size: 1.6rem; color: var(--primary-color); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .section-header.metric-header { color: var(--accent-color); border-color: #ffe0b2; }

        /* SORU KARTLARI */
        .question-group { margin-bottom: 25px; padding: 25px; border: 1px solid #eee; border-radius: 8px; background: #fff; transition: border 0.2s; }
        .question-group:hover { border-color: #ccc; }
        .question-group.hidden { display: none; }
        .question-group.is-child { background-color: var(--child-bg); border-left: 5px solid var(--child-border); }
        
        label { display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 1rem; }
        .description { font-size: 0.9rem; color: #666; margin-bottom: 15px; background: #fafafa; padding: 10px; border-radius: 6px; line-height: 1.5; border-left: 3px solid #eee; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; cursor: pointer; padding: 5px; border-radius: 4px; }
        .checkbox-item:hover { background: #f8f9fa; }
        .checkbox-item input { width: 18px; height: 18px; margin-right: 10px; accent-color: var(--secondary-color); }
        .q-badge { background: #eee; color: #888; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; font-weight: normal; }
    </style>
</head>
<body>

    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleFileLoad(event)">

    <div id="sector-modal">
        <div class="modal-content">
            <h2>HoÅŸ Geldiniz</h2>
            <p>Raporlama sÃ¼recine baÅŸlamadan Ã¶nce lÃ¼tfen firmanÄ±zÄ±n ana sektÃ¶rÃ¼nÃ¼ seÃ§iniz.</p>
            <select id="sectorSelect" class="sector-select"><option value="">YÃ¼kleniyor...</option></select>
            <button id="startBtn" class="start-btn" onclick="startApplication()" disabled>BAÅžLA</button>
            <button class="modal-load-btn" onclick="document.getElementById('jsonFileInput').click()">ðŸ“‚ KayÄ±tlÄ± Dosya YÃ¼kle</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="framework-selector">
            <button id="btn-tsrs" class="fw-btn active" onclick="switchFramework('tsrs')">TSRS</button>
            <button id="btn-gri" class="fw-btn" onclick="switchFramework('gri')">GRI</button>
            <button id="btn-metrics" class="fw-btn" onclick="switchFramework('metrics')">METRÄ°KLER</button>
        </div>
        <div class="actions-panel">
            <button class="action-btn btn-save" onclick="exportProgress()">ðŸ’¾ Kaydet</button>
            <button class="action-btn btn-load" onclick="document.getElementById('jsonFileInput').click()">ðŸ“‚ YÃ¼kle</button>
        </div>
        <div class="sidebar-header">
            <h2 id="menu-title">TSRS BaÅŸlÄ±klarÄ±</h2>
            <div id="active-sector-display" class="active-sector-badge" style="display:none;"></div>
        </div>
        <div id="sidebar-menu-items"></div>
    </div>

    <div class="main-content" id="mainContent">
        <div style="text-align:center; color:#888; margin-top:50px;">LÃ¼tfen sektÃ¶r seÃ§imi yapÄ±nÄ±z...</div>
    </div>

    <script>
        // ==========================================
        // 1. AYARLAR & API
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzzYVodLj9QirWGkyXaHbpxVjZjDxSXl7anG1mW9HpvYMLlQfIbiHfn4F7WYLAr0Dkn/exec";

        const tsrsOrder = [
            "Genel HÃ¼kÃ¼mler Ve Bilgiler",
            "YÃ¶netiÅŸim (Governance)",
            "Strateji (Strategy)",
            "Risk YÃ¶netimi (Risk Management)",
            "Metrikler Ve Hedefler (Metrics & Targets)"
        ];

        // ==========================================
        // 2. GLOBAL DEÄžÄ°ÅžKENLER
        // ==========================================
        let allQuestions = [];
        let filteredQuestions = [];
        let groupedData = {}; 
        let questionMap = {};
        let dependencies = {};
        
        let currentFramework = 'tsrs';
        let userSector = null;
        let debounceTimer;

        // UI Elementleri
        const sectorSelect = document.getElementById('sectorSelect');
        const startBtn = document.getElementById('startBtn');
        const modal = document.getElementById('sector-modal');
        const activeSectorDisplay = document.getElementById('active-sector-display');
        const mainContent = document.getElementById('mainContent');
        const sidebarMenuItems = document.getElementById('sidebar-menu-items');
        const menuTitle = document.getElementById('menu-title');

        // ==========================================
        // 3. BAÅžLANGIÃ‡
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    allQuestions = data;
                    initSectorSelection();
                })
                .catch(err => {
                    console.error(err);
                    alert("Veri Ã§ekilemedi!");
                });
        });

        function initSectorSelection() {
            const sectors = new Set();
            allQuestions.forEach(q => {
                const arr = q.firma_sektor;
                if (Array.isArray(arr) && arr.length > 0) {
                    arr.forEach(s => {
                        if (s && s !== "GENEL" && s.trim() !== "") sectors.add(s.trim());
                    });
                }
            });
            const sorted = Array.from(sectors).sort();
            sectorSelect.innerHTML = '<option value="">LÃ¼tfen SektÃ¶r SeÃ§iniz...</option>';
            sorted.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                sectorSelect.appendChild(opt);
            });
            sectorSelect.addEventListener('change', () => startBtn.disabled = (sectorSelect.value === ""));
        }

        // ==========================================
        // 4. UYGULAMA MANTIÄžI
        // ==========================================
        function startApplication() {
            userSector = sectorSelect.value;
            if (!userSector) return;

            modal.style.opacity = '0';
            setTimeout(() => { modal.style.display = 'none'; }, 500);

            activeSectorDisplay.textContent = userSector;
            activeSectorDisplay.style.display = 'inline-block';

            filteredQuestions = allQuestions.filter(q => {
                const arr = q.firma_sektor;
                const isEmpty = !arr || arr.length === 0 || (arr.length === 1 && arr[0] === "");
                if (isEmpty) return true; 
                return arr.includes("GENEL") || arr.includes(userSector);
            });

            processData();
        }

        function switchFramework(mode) {
            if (currentFramework === mode) return;
            currentFramework = mode;
            updateFrameworkUI();
            processData();
        }

        function updateFrameworkUI() {
            document.querySelectorAll('.fw-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + currentFramework).classList.add('active');

            if (currentFramework === 'tsrs') menuTitle.textContent = "TSRS BaÅŸlÄ±klarÄ±";
            else if (currentFramework === 'gri') menuTitle.textContent = "GRI BaÅŸlÄ±klarÄ±";
            else menuTitle.textContent = "Metrik Kategorileri";
        }

        function processData() {
            groupedData = {};
            questionMap = {};
            dependencies = {};

            filteredQuestions.forEach(q => {
                questionMap[q.id] = q;

                if (q.baglilik && q.baglilik.parent_id) {
                    const pid = q.baglilik.parent_id;
                    if (!dependencies[pid]) dependencies[pid] = [];
                    if (!dependencies[pid].includes(q.id)) dependencies[pid].push(q.id);
                }

                let main = "", sub = "";
                if (currentFramework === 'tsrs') {
                    main = q.konumlandirma?.tsrs?.main;
                    sub = q.konumlandirma?.tsrs?.sub;
                } else if (currentFramework === 'gri') {
                    main = q.konumlandirma?.gri?.main;
                    sub = q.konumlandirma?.gri?.sub;
                } else if (currentFramework === 'metrics') {
                    if (q.metrik_kategori && q.metrik_kategori.trim() !== "") {
                        main = q.metrik_kategori;
                        sub = "_dummy_";
                    } else return;
                }

                if (!main) return;
                if (!sub) sub = "Genel";

                if (!groupedData[main]) groupedData[main] = {};
                if (!groupedData[main][sub]) groupedData[main][sub] = [];
                groupedData[main][sub].push(q);
            });

            renderAll();
        }

        function getSortedMainKeys() {
            let keys = Object.keys(groupedData);
            if (currentFramework === 'tsrs') {
                keys.sort((a, b) => {
                    let iA = tsrsOrder.indexOf(a), iB = tsrsOrder.indexOf(b);
                    if (iA === -1) iA = 999; if (iB === -1) iB = 999;
                    return (iA === 999 && iB === 999) ? a.localeCompare(b) : iA - iB;
                });
            } else {
                keys.sort((a, b) => a.localeCompare(b));
            }
            return keys;
        }

        // ==========================================
        // 5. RENDER (GÃ–RÃœNTÃœLEME)
        // ==========================================
        function renderAll() {
            renderSidebar();
            renderMainContent(); 
            
            // EÄŸer yÃ¼klenmesi beklenen veri varsa (Import iÅŸlemi), onu ÅŸimdi yÃ¼kle
            // Bu kÄ±sÄ±m startApplication'dan hemen sonra Ã§alÄ±ÅŸtÄ±ÄŸÄ± iÃ§in
            // renderAll iÃ§inde pendingRestoreData'yÄ± kontrol etmek en gÃ¼venlisidir.
            if (window.pendingRestoreData) {
                restoreAnswers(window.pendingRestoreData);
                window.pendingRestoreData = null; // Ä°ÅŸlendikten sonra temizle
            } else {
                // Sadece yeni baÅŸlanÄ±yorsa hesapla
                updateProgress(true);
            }

            // Ä°lk sayfayÄ± aÃ§
            const mainKeys = getSortedMainKeys();
            if (mainKeys.length > 0) {
                if (currentFramework === 'metrics') {
                    showSection(`section-${mainKeys[0]}`);
                    const firstItem = document.getElementById(`nav-main-0`);
                    if(firstItem) firstItem.classList.add('active-metric');
                } else {
                    const firstGroup = document.querySelector('.nav-group');
                    if (firstGroup) firstGroup.classList.remove('collapsed');
                    
                    const subKeys = Object.keys(groupedData[mainKeys[0]]);
                    if (subKeys.length > 0) {
                        showSection(`section-${mainKeys[0]}-${subKeys[0]}`);
                        const subItem = document.getElementById(`nav-sub-0-0`);
                        if(subItem) subItem.classList.add('active');
                    }
                }
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active-view'));
            const target = document.getElementById(sectionId);
            if(target) {
                target.classList.add('active-view');
                mainContent.scrollTop = 0;
            }
        }

        function renderSidebar() {
            sidebarMenuItems.innerHTML = '';
            const mainKeys = getSortedMainKeys();
            const isMetric = (currentFramework === 'metrics');

            mainKeys.forEach((mainKey, mIdx) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'nav-group collapsed';

                const mainItem = document.createElement('div');
                mainItem.className = 'nav-main-item';
                if (!isMetric) mainItem.classList.add('has-children');
                mainItem.id = `nav-main-${mIdx}`;
                
                mainItem.innerHTML = `
                    <span class="title">${mainKey}</span>
                    <span class="badge badge-main" id="badge-main-${mIdx}">0/0</span>
                `;

                if (isMetric) {
                    mainItem.onclick = () => {
                        document.querySelectorAll('.nav-main-item').forEach(e => e.classList.remove('active-metric'));
                        mainItem.classList.add('active-metric');
                        showSection(`section-${mainKey}`);
                    };
                } else {
                    mainItem.onclick = () => {
                        const isCollapsed = groupDiv.classList.contains('collapsed');
                        document.querySelectorAll('.nav-group').forEach(g => g.classList.add('collapsed'));
                        if(isCollapsed) groupDiv.classList.remove('collapsed');
                        else groupDiv.classList.add('collapsed');
                    };
                }
                groupDiv.appendChild(mainItem);

                if (!isMetric) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'nav-sub-items';
                    const subKeys = Object.keys(groupedData[mainKey]);
                    subKeys.forEach((subKey, sIdx) => {
                        const subItem = document.createElement('div');
                        subItem.className = 'nav-sub-item';
                        subItem.id = `nav-sub-${mIdx}-${sIdx}`;
                        subItem.innerHTML = `<span>${subKey}</span><span class="badge" id="badge-sub-${mIdx}-${sIdx}">0/0</span>`;
                        subItem.onclick = () => {
                            document.querySelectorAll('.nav-sub-item').forEach(e => e.classList.remove('active'));
                            subItem.classList.add('active');
                            showSection(`section-${mainKey}-${subKey}`);
                        };
                        subContainer.appendChild(subItem);
                    });
                    groupDiv.appendChild(subContainer);
                }
                sidebarMenuItems.appendChild(groupDiv);
            });
        }

        function renderMainContent() {
            mainContent.innerHTML = '';
            const mainKeys = getSortedMainKeys();
            const isMetric = (currentFramework === 'metrics');

            if (mainKeys.length === 0) {
                mainContent.innerHTML = `<div style="text-align:center;color:#666;margin-top:50px;">GÃ¶rÃ¼ntÃ¼lenecek soru bulunamadÄ±.</div>`;
                return;
            }

            mainKeys.forEach((mainKey, mIdx) => {
                if (isMetric) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'content-section';
                    sectionDiv.id = `section-${mainKey}`;

                    const header = document.createElement('div');
                    header.className = 'section-header metric-header';
                    header.textContent = mainKey;
                    sectionDiv.appendChild(header);

                    if (groupedData[mainKey]["_dummy_"]) {
                        groupedData[mainKey]["_dummy_"].forEach(q => sectionDiv.appendChild(createQuestionElement(q)));
                    }
                    mainContent.appendChild(sectionDiv);
                } else {
                    Object.keys(groupedData[mainKey]).forEach((subKey, sIdx) => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'content-section';
                        sectionDiv.id = `section-${mainKey}-${subKey}`;

                        const header = document.createElement('div');
                        header.className = 'section-header';
                        header.innerHTML = `<span>${mainKey} <small style="color:#999;font-size:0.8em;">/ ${subKey}</small></span>`;
                        sectionDiv.appendChild(header);

                        groupedData[mainKey][subKey].forEach(q => sectionDiv.appendChild(createQuestionElement(q)));
                        mainContent.appendChild(sectionDiv);
                    });
                }
            });
        }

        // ==========================================
        // 6. SORU OLUÅžTURUCU (OPTIMIZED)
        // ==========================================
        function createQuestionElement(q) {
            const div = document.createElement('div');
            div.className = 'question-group';
            div.id = 'wrapper-' + q.id;

            if (q.baglilik && q.baglilik.parent_id) {
                div.classList.add('hidden', 'is-child');
            }

            div.innerHTML = `<label>${q.soru_metni} <span class="q-badge">${q.id}</span></label>`;
            if (q.soru_aciklama) div.innerHTML += `<div class="description">${q.soru_aciklama}</div>`;

            let inputHTML = '';
            const name = `q_${q.id}`;
            const type = q.cevap_tipi;
            const answers = q.cevap || [];

            if (type === 'Metin') inputHTML = `<textarea id="${name}" rows="2"></textarea>`;
            else if (type === 'SayÄ±' || type === 'Oran') inputHTML = `<input type="number" id="${name}" step="${type==='Oran'?'0.01':'1'}">`;
            else if (type === 'Tarih') inputHTML = `<input type="date" id="${name}">`;
            else if (type === 'URL') inputHTML = `<input type="url" id="${name}">`;
            else if (type === 'Tekli') {
                inputHTML = `<select id="${name}"><option value="">SeÃ§iniz...</option>${answers.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
            } else if (type === 'Ã‡oklu') {
                inputHTML = `<div class="checkbox-group">${answers.map(o=>`<label class="checkbox-item"><input type="checkbox" name="${name}" value="${o}">${o}</label>`).join('')}</div>`;
            } else if (type === 'Dosya') {
                inputHTML = `<input type="file" id="${name}">`;
            } else inputHTML = `<input type="text" id="${name}">`;

            const container = document.createElement('div');
            container.innerHTML = inputHTML;
            div.appendChild(container);

            const inputs = div.querySelectorAll('input, select, textarea');
            inputs.forEach(inp => {
                // 1. Tetikleyici anlÄ±k Ã§alÄ±ÅŸsÄ±n
                const triggerHandler = () => checkTriggers(q.id);
                // 2. Ä°lerleme barÄ± gecikmeli Ã§alÄ±ÅŸsÄ±n (Performance)
                const progressHandler = () => debouncedUpdateProgress();

                inp.addEventListener('change', triggerHandler);
                inp.addEventListener('change', progressHandler);

                if(inp.type !== 'checkbox') {
                    inp.addEventListener('input', triggerHandler);
                    inp.addEventListener('input', progressHandler);
                }
            });

            return div;
        }

        // ==========================================
        // 7. PERFORMANS VE TETÄ°KLEYÄ°CÄ°LER
        // ==========================================
        
        function debouncedUpdateProgress() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateProgress();
            }, 300);
        }

        function updateProgress(force = false) {
            const mainKeys = getSortedMainKeys();
            const isMetric = (currentFramework === 'metrics');

            mainKeys.forEach((mainKey, mIdx) => {
                let mainTotal = 0, mainAnswered = 0, isMainCompleted = true;
                const subKeys = Object.keys(groupedData[mainKey]);
                
                subKeys.forEach((subKey, sIdx) => {
                    const questions = groupedData[mainKey][subKey];
                    const subTotal = questions.length;
                    let subAnswered = 0;

                    for (let i = 0; i < subTotal; i++) {
                        const q = questions[i];
                        const val = getAnswerValue(q.id);
                        if (val && (Array.isArray(val) ? val.length > 0 : val.toString().trim() !== "")) {
                            subAnswered++;
                        }
                    }

                    if (!isMetric) {
                        const subBadge = document.getElementById(`badge-sub-${mIdx}-${sIdx}`);
                        const subItem = document.getElementById(`nav-sub-${mIdx}-${sIdx}`);
                        if (subBadge) subBadge.textContent = `${subAnswered}/${subTotal}`;
                        
                        if (subAnswered === subTotal && subTotal > 0) subItem.classList.add('completed');
                        else { subItem.classList.remove('completed'); isMainCompleted = false; }
                    }

                    mainTotal += subTotal;
                    mainAnswered += subAnswered;
                });

                if (isMetric) isMainCompleted = (mainAnswered === mainTotal && mainTotal > 0);

                const mainBadge = document.getElementById(`badge-main-${mIdx}`);
                const mainItem = document.getElementById(`nav-main-${mIdx}`);
                if (mainBadge) mainBadge.textContent = `${mainAnswered}/${mainTotal}`;
                
                if (isMainCompleted && mainTotal > 0) mainItem.classList.add('completed');
                else mainItem.classList.remove('completed');
            });
        }

        function checkTriggers(pid) {
            const childIds = dependencies[pid];
            if (!childIds) return;
            const pVal = getAnswerValue(pid);

            childIds.forEach(cid => {
                const el = document.getElementById('wrapper-' + cid);
                if (!el) return;
                
                const q = questionMap[cid];
                if (!q) return;

                const trig = q.baglilik.tetikleyici || [];
                let show = false;
                if (trig.length && pVal) {
                    if (Array.isArray(pVal)) show = pVal.some(v => trig.includes(v));
                    else show = trig.includes(pVal);
                }
                
                if (show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function getAnswerValue(id) {
            const q = questionMap[id];
            if (!q) return null;
            
            if (q.cevap_tipi === 'Ã‡oklu') {
                const checked = document.querySelectorAll(`input[name="q_${id}"]:checked`);
                if (checked.length === 0) return null;
                const vals = [];
                for(let i=0; i<checked.length; i++) vals.push(checked[i].value);
                return vals;
            } 
            
            const el = document.getElementById(`q_${id}`);
            return el ? el.value : null;
        }

        // ==========================================
        // 8. IMPORT / EXPORT (DÃœZELTÄ°LDÄ°)
        // ==========================================

        function exportProgress() {
            if (!userSector) { alert("SektÃ¶r seÃ§ilmedi."); return; }
            const data = { meta: { date: new Date(), sector: userSector, framework: currentFramework }, answers: {} };
            
            filteredQuestions.forEach(q => {
                const val = getAnswerValue(q.id);
                if (val && (Array.isArray(val) ? val.length : val !== "")) data.answers[q.id] = val;
            });

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Taslak_${userSector}_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function handleFileLoad(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            
            r.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if (!d.meta?.sector) throw new Error("GeÃ§ersiz dosya");
                    
                    // 1. Ã–nce SektÃ¶rÃ¼ ayarla
                    userSector = d.meta.sector;
                    sectorSelect.value = userSector;

                    // 2. CevaplarÄ± HAFIZAYA al (Ekran Ã§izilmeden Ã¶nce)
                    window.pendingRestoreData = d.answers;

                    // 3. UygulamayÄ± baÅŸlat (DOM oluÅŸsun)
                    // startApplication -> processData -> renderAll sÄ±rasÄ±yla Ã§alÄ±ÅŸÄ±r.
                    // renderAll fonksiyonu pendingRestoreData'yÄ± gÃ¶rÃ¼p dolduracaktÄ±r.
                    startApplication(); 

                    // 4. Framework farklÄ±ysa deÄŸiÅŸtir (Bu da yeniden render tetikler)
                    if (d.meta.framework && d.meta.framework !== currentFramework) {
                        switchFramework(d.meta.framework);
                    }
                    
                    alert("Taslak baÅŸarÄ±yla yÃ¼klendi!");

                } catch(err) { alert("Hata: " + err.message); }
            };
            r.readAsText(f);
            e.target.value = '';
        }

        function restoreAnswers(ans) {
            Object.keys(ans).forEach(qid => {
                const val = ans[qid];
                const q = questionMap[qid];
                if (!q) return;
                
                if (q.cevap_tipi === 'Ã‡oklu' && Array.isArray(val)) {
                    val.forEach(v => {
                        const cb = document.querySelector(`input[name="q_${qid}"][value="${v}"]`);
                        if(cb) cb.checked = true;
                    });
                } else {
                    const el = document.getElementById(`q_${qid}`);
                    if(el) el.value = val;
                }
                checkTriggers(qid);
            });
            updateProgress(true); // YÃ¼klemede tam gÃ¼Ã§ gÃ¼ncelle
        }

    </script>
</body>
</html>
